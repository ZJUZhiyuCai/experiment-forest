<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI思维导图测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .result {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }
        .loading {
            background: #fff3e0;
            border-color: #ff9800;
            color: #ef6c00;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>🧠 AI思维导图功能测试</h1>
    <p>此页面用于独立测试AI生成思维导图功能，帮助诊断问题。</p>

    <div class="test-section">
        <h2>1. API配置测试</h2>
        <div class="input-group">
            <label>API端点:</label>
            <input type="text" id="apiEndpoint" placeholder="https://api.siliconflow.cn/v1/chat/completions">
        </div>
        <div class="input-group">
            <label>API密钥:</label>
            <input type="password" id="apiKey" placeholder="sk-...">
        </div>
        <div class="input-group">
            <label>模型名称:</label>
            <input type="text" id="model" value="qwen2.5-72b-instruct">
        </div>
        <button onclick="testAPIConnection()">测试API连接</button>
        <div id="apiResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>2. 模拟课题数据</h2>
        <div class="input-group">
            <label>课题标题:</label>
            <input type="text" id="projectTitle" value="基于CRISPR技术的基因编辑实验研究">
        </div>
        <div class="input-group">
            <label>课题描述:</label>
            <textarea id="projectDescription" rows="3">研究CRISPR-Cas9系统在特定基因位点的编辑效率，分析不同导向RNA序列对编辑精度的影响</textarea>
        </div>
        <div class="input-group">
            <label>实验记录数量:</label>
            <input type="number" id="recordCount" value="5">
        </div>
        <div class="input-group">
            <label>笔记数量:</label>
            <input type="number" id="noteCount" value="3">
        </div>
        <div class="input-group">
            <label>SOP数量:</label>
            <input type="number" id="sopCount" value="2">
        </div>
    </div>

    <div class="test-section">
        <h2>3. AI生成配置</h2>
        <div class="input-group">
            <label>包含内容:</label>
            <div>
                <input type="checkbox" id="includeExperiments" checked> 实验记录
                <input type="checkbox" id="includeNotes" checked> 研究笔记
                <input type="checkbox" id="includeSOPs" checked> SOP文档
            </div>
        </div>
        <div class="input-group">
            <label>布局样式:</label>
            <select id="style">
                <option value="hierarchical">层次化</option>
                <option value="radial">放射状</option>
                <option value="network">网络状</option>
            </select>
        </div>
        <div class="input-group">
            <label>详细程度:</label>
            <select id="detailLevel">
                <option value="basic">基本</option>
                <option value="detailed" selected>详细</option>
                <option value="comprehensive">全面</option>
            </select>
        </div>
        <div class="input-group">
            <label>最大节点数:</label>
            <input type="number" id="maxNodes" value="30" min="10" max="100">
        </div>
    </div>

    <div class="test-section">
        <h2>4. 生成思维导图</h2>
        <button onclick="generateMindMap()" id="generateBtn">生成AI思维导图</button>
        <div id="generationResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>5. 问题诊断</h2>
        <button onclick="runDiagnostics()">运行完整诊断</button>
        <div id="diagnosticsResult" class="result" style="display: none;"></div>
    </div>

    <script>
        // 从localStorage加载AI设置
        function loadSettings() {
            const saved = localStorage.getItem('aiSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    document.getElementById('apiEndpoint').value = settings.apiEndpoint || '';
                    document.getElementById('apiKey').value = settings.apiKey || '';
                    document.getElementById('model').value = settings.model || 'qwen2.5-72b-instruct';
                } catch (e) {
                    console.error('读取AI设置失败:', e);
                }
            }
        }

        // 测试API连接
        async function testAPIConnection() {
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('model').value.trim();
            
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = '正在测试API连接...';

            if (!apiEndpoint || !apiKey) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 请填写API端点和密钥';
                return;
            }

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: '你是一个测试助手。' },
                            { role: 'user', content: '请回复"连接测试成功"' }
                        ],
                        max_tokens: 50,
                        temperature: 0.1
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `❌ API连接失败 (${response.status}): ${errorText}`;
                    return;
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ API连接成功！<br>响应内容：${data.choices[0].message.content}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ API响应格式异常';
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ 网络连接失败：${error.message}`;
            }
        }

        // 构建AI提示词
        function buildPrompt() {
            const projectTitle = document.getElementById('projectTitle').value;
            const projectDescription = document.getElementById('projectDescription').value;
            const recordCount = document.getElementById('recordCount').value;
            const noteCount = document.getElementById('noteCount').value;
            const sopCount = document.getElementById('sopCount').value;
            const style = document.getElementById('style').value;
            const detailLevel = document.getElementById('detailLevel').value;

            const styleText = style === 'hierarchical' ? '层次化' : style === 'radial' ? '放射状' : '网络状';

            return `请为以下生命医药研究课题生成一个专业的思维导图结构：

课题信息：
- 标题：${projectTitle}
- 描述：${projectDescription}
- 状态：active
- 进度：25%
- 研究目标：验证基因编辑效率、分析导向RNA影响、优化实验条件

数据统计：
- 实验记录：${recordCount}个
- 研究笔记：${noteCount}个
- SOP文档：${sopCount}个

实验类型分布：
- 基因编辑实验: 3个
- 细胞培养: 1个
- PCR扩增: 1个

主要研究笔记：
- CRISPR系统设计原理
- 导向RNA序列筛选方法
- 基因编辑效率评估标准

相关SOP文档：
- CRISPR-Cas9基因编辑标准操作流程 (实验操作)
- 细胞培养及转染协议 (细胞实验)

请生成一个${styleText}的思维导图，包含以下要素：

1. 中心节点：课题主题
2. 主要分支：
   - 研究目标和假设
   - 实验设计和方法
   - 数据收集和分析
   - 结果和讨论
   - 问题和挑战
   - 下一步工作

3. 具体细节：
   - 根据现有实验记录添加具体的实验节点
   - 包含相关的技术方法和设备
   - 标注关键数据点和发现
   - 识别潜在的研究方向

请以JSON格式返回，包含节点数组和连接数组。每个节点应包含：id, title, type, category, description, priority。

详细程度：${detailLevel}
最大节点数：不超过50个

请确保思维导图结构合理，层次清晰，便于理解和进一步编辑。`;
        }

        // 生成思维导图
        async function generateMindMap() {
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('model').value.trim();

            const resultDiv = document.getElementById('generationResult');
            const generateBtn = document.getElementById('generateBtn');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = '🤖 AI正在生成思维导图，请稍候...';
            generateBtn.disabled = true;

            if (!apiEndpoint || !apiKey) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '❌ 请先配置并测试API连接';
                generateBtn.disabled = false;
                return;
            }

            try {
                const prompt = buildPrompt();
                
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'system',
                                content: '你是一位专业的AI助手，擅长创建清晰、有逻辑的思维导图。请根据用户需求生成结构化的思维导图数据。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `❌ AI生成失败 (${response.status}): ${errorText}`;
                    generateBtn.disabled = false;
                    return;
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    
                    try {
                        // 尝试解析JSON
                        const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsedData = JSON.parse(jsonMatch[0]);
                            resultDiv.className = 'result success';
                            resultDiv.innerHTML = `✅ AI思维导图生成成功！<br><br>` +
                                `<strong>生成的结构：</strong><br>` +
                                `节点数量：${parsedData.nodes ? parsedData.nodes.length : '未知'}<br>` +
                                `连接数量：${parsedData.edges ? parsedData.edges.length : '未知'}<br><br>` +
                                `<strong>完整响应：</strong><br>` +
                                `<pre>${JSON.stringify(parsedData, null, 2)}</pre>`;
                        } else {
                            resultDiv.className = 'result error';
                            resultDiv.innerHTML = `❌ AI响应中未找到有效JSON数据<br><br>` +
                                `<strong>原始响应：</strong><br>` +
                                `<pre>${aiResponse}</pre>`;
                        }
                    } catch (parseError) {
                        resultDiv.className = 'result error';
                        resultDiv.innerHTML = `❌ JSON解析失败：${parseError.message}<br><br>` +
                            `<strong>原始响应：</strong><br>` +
                            `<pre>${aiResponse}</pre>`;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '❌ AI响应格式异常';
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ 网络请求失败：${error.message}`;
            } finally {
                generateBtn.disabled = false;
            }
        }

        // 运行完整诊断
        async function runDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            let diagnostics = '🔍 <strong>AI思维导图功能诊断报告</strong><br><br>';

            // 1. 检查localStorage中的AI设置
            diagnostics += '<strong>1. AI设置检查：</strong><br>';
            const savedSettings = localStorage.getItem('aiSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    diagnostics += `✅ AI设置已保存<br>`;
                    diagnostics += `- API端点：${settings.apiEndpoint ? '已配置' : '❌ 未配置'}<br>`;
                    diagnostics += `- API密钥：${settings.apiKey ? '已配置' : '❌ 未配置'}<br>`;
                    diagnostics += `- 模型：${settings.model || '❌ 未指定'}<br>`;
                    diagnostics += `- 启用自定义API：${settings.useCustomAPI ? '✅ 是' : '❌ 否'}<br>`;
                } catch (e) {
                    diagnostics += `❌ AI设置格式错误<br>`;
                }
            } else {
                diagnostics += `❌ 未找到AI设置<br>`;
            }

            // 2. 检查思维导图服务
            diagnostics += '<br><strong>2. 思维导图服务检查：</strong><br>';
            try {
                // 检查mindMapAIService是否可用
                if (typeof window.mindMapAIService !== 'undefined') {
                    diagnostics += `✅ mindMapAIService已加载<br>`;
                } else {
                    diagnostics += `❌ mindMapAIService未加载<br>`;
                }
            } catch (e) {
                diagnostics += `❌ 无法访问mindMapAIService: ${e.message}<br>`;
            }

            // 3. 检查网络连接
            diagnostics += '<br><strong>3. 网络连接检查：</strong><br>';
            try {
                const testResponse = await fetch('https://httpbin.org/get', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (testResponse.ok) {
                    diagnostics += `✅ 网络连接正常<br>`;
                } else {
                    diagnostics += `❌ 网络连接异常<br>`;
                }
            } catch (e) {
                diagnostics += `❌ 网络连接失败：${e.message}<br>`;
            }

            // 4. 浏览器支持检查
            diagnostics += '<br><strong>4. 浏览器支持检查：</strong><br>';
            diagnostics += `- Fetch API：${typeof fetch !== 'undefined' ? '✅ 支持' : '❌ 不支持'}<br>`;
            diagnostics += `- localStorage：${typeof localStorage !== 'undefined' ? '✅ 支持' : '❌ 不支持'}<br>`;
            diagnostics += `- JSON：${typeof JSON !== 'undefined' ? '✅ 支持' : '❌ 不支持'}<br>`;

            // 5. 错误日志检查
            diagnostics += '<br><strong>5. 常见问题排查：</strong><br>';
            
            const currentSettings = {
                apiEndpoint: document.getElementById('apiEndpoint').value.trim(),
                apiKey: document.getElementById('apiKey').value.trim(),
                model: document.getElementById('model').value.trim()
            };

            if (!currentSettings.apiEndpoint) {
                diagnostics += `❌ API端点未配置，请在设置页面配置<br>`;
            } else if (!currentSettings.apiEndpoint.includes('/chat/completions')) {
                diagnostics += `⚠️ API端点可能缺少路径，建议确认是否包含"/chat/completions"<br>`;
            }

            if (!currentSettings.apiKey) {
                diagnostics += `❌ API密钥未配置<br>`;
            } else if (currentSettings.apiKey.length < 10) {
                diagnostics += `⚠️ API密钥似乎太短，请检查是否完整<br>`;
            }

            if (!currentSettings.model) {
                diagnostics += `❌ 模型名称未指定<br>`;
            }

            diagnostics += '<br><strong>6. 解决建议：</strong><br>';
            diagnostics += `1. 确保在"设置"页面正确配置AI API<br>`;
            diagnostics += `2. 点击"测试API连接"确认配置正确<br>`;
            diagnostics += `3. 检查网络连接和防火墙设置<br>`;
            diagnostics += `4. 如果使用国内网络，可能需要配置代理<br>`;
            diagnostics += `5. 确认API密钥有足够余额和权限<br>`;

            resultDiv.innerHTML = diagnostics;
        }

        // 页面加载时自动读取设置
        window.onload = function() {
            loadSettings();
        };
    </script>
</body>
</html>